index.html

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Vazão - IFCE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; background: #e0f7fa; text-align:center; margin:0; padding:0; }
.container { background:white; padding:20px; margin:20px auto; border-radius:12px; max-width:600px; }
h1 { color:#0288D1; }
.valor { font-size:28px; color:#00796B; margin:10px 0; }
button { margin-top:10px; padding:8px 16px; background:#00796B; color:white; border:none; border-radius:5px; cursor:pointer; }
canvas { background:#f9f9f9; border-radius:8px; }
ul { list-style:none; padding:0; text-align:left; }
li { background:#f1f1f1; margin:5px 0; padding:5px; border-radius:5px; }
</style>
</head>
<body>
<div class="container">
  <h1>Dashboard de Vazão - IFCE</h1>
  <div class="valor" id="vazaoAtual">Vazão: -- mm/h</div>
  <div class="valor" id="volumeTotal">Volume: -- L</div>
  <canvas id="graficoVazao" width="500" height="300"></canvas>
  <ul id="historico"></ul>
  <button onclick="exportarCSV()">Exportar CSV</button>
</div>

<script>
const urlGoogleScript = "https://script.google.com/macros/s/AKfycbwZRL2g3cump7W1UnV64ghtu_WRKydVMnAIMHp5-lZ_ToUEFwABA4pvy4UCkynNiuqOtw/exec?modo=leitura";

let historicoCSV = [];
let labels = [];
let dadosVazao = [];

const ctx = document.getElementById('graficoVazao').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Vazão (mm/h)',
      data: dadosVazao,
      borderColor: '#0288D1',
      backgroundColor: 'rgba(2,136,209,0.2)',
      tension: 0.3,
      fill: true,
      pointRadius: 5
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: true } },
    scales: {
      x: { title: { display: true, text: 'Horário' } },
      y: { title: { display: true, text: 'Vazão (mm/h)' }, beginAtZero:true }
    }
  }
});

function atualizarDashboard(){
  fetch(urlGoogleScript)
    .then(res => res.json())
    .then(data => {
      // Mantém apenas os últimos 5 registros
      const ultimos = data.slice(-5);

      labels.length = 0;
      dadosVazao.length = 0;
      historicoCSV = [["Vazão","Horário","Data"]];
      let historicoHTML = "";

      ultimos.forEach(item => {
        labels.push(item.horario);
        dadosVazao.push(parseFloat(item.vazao));
        historicoCSV.push([item.vazao, item.horario, item.data]);
        historicoHTML += "<li>"+item.vazao+" mm/h às "+item.horario+"</li>";
      });

      chart.update();
      document.getElementById("historico").innerHTML = historicoHTML;

      // Atualiza valores atuais
      if(ultimos.length>0){
        const ultimo = ultimos[ultimos.length-1];
        document.getElementById('vazaoAtual').innerText = "Vazão: " + ultimo.vazao + " mm/h às " + ultimo.horario;
        let volumeAcumulado = dadosVazao.reduce((a,b)=>a+b,0) * 0.0024691358;
        document.getElementById('volumeTotal').innerText = "Volume total: " + volumeAcumulado.toFixed(2) + " L";
      }
    })
    .catch(err => console.log("Erro ao buscar dados: ", err));
}

// Atualiza a cada 10 segundos
atualizarDashboard();
setInterval(atualizarDashboard,10000);

function exportarCSV(){
  let csvContent = "data:text/csv;charset=utf-8," + historicoCSV.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download","dados_vazao.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>

</html>
